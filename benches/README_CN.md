# BLAKE3 基准测试套件

本模块提供 BLAKE3 哈希函数的全面基准测试，并针对测量稳定性和可靠性进行了各种优化。

## 稳定性优化

基准测试实现了多种技术来提高测量稳定性：

- **内存预分配**: 缓冲区预先分配，避免在计时区间内进行垃圾回收和内存分配
- **缓存预热**: 在基准测试前访问输入数据，确保数据在 CPU 缓存中，减少缓存未命中延迟变化
- **页对齐随机化**: 输入偏移量在页边界之间随机化，避免系统性对齐偏差
- **中断/调度器缓解**: 使用 `test::black_box` 防止编译器优化，帮助减少中断引起的计时变化

## 性能注意事项

- **缓冲区大小**: 较大的缓冲区可能导致缓存驱逐；较小的缓冲区可能无法充分利用 SIMD 并行性
- **内存占用**: 每个 `RandomInput` 分配 `(len + page_size)` 字节以允许偏移量随机化
- **互操作性**: 基准测试与多个 SIMD 平台兼容（SSE2、SSE4.1、AVX2、AVX-512、NEON、WASM SIMD）

## 基准测试分类

### 单次压缩基准测试
在特定平台上对单次压缩函数调用进行基准测试。

### 多块哈希基准测试
在特定平台上使用 SIMD 对并行块哈希进行基准测试。

SIMD 度数决定了并行哈希多少块：
- SSE2/SSE4.1: 4 块
- AVX2: 8 块
- AVX-512: 16 块
- NEON/WASM: 4 块

### 父节点哈希基准测试
父节点哈希操作 BLOCK_LEN（64 字节）而不是 CHUNK_LEN（1024 字节）。

### 一次性哈希基准测试
测量所有输入一次性可用的最佳情况。

### 增量哈希基准测试
使用 `Hasher::new()`、`update()` 和 `finalize()` 对增量哈希进行基准测试。

### 参考实现基准测试
参考实现故意简单且未优化。将其与优化实现进行比较，显示 SIMD 和并行处理的性能优势。

### Rayon（多线程）基准测试
多线程有开销。对于小输入（x86_64 上 < 128 KiB），单线程哈希可能更快。

### 扩展输出（XOF）基准测试
XOF 性能与输出大小成比例。为了在循环中获得最佳性能，请使用 BLOCK_LEN（64 字节）倍数的缓冲区大小。

## RandomInput 结构

用于生成具有页对齐偏移量的随机化基准测试输入的结构。

### 稳定性特性

- **预分配**: 所有内存在构造时分配，避免在基准测试迭代期间分配（减少 GC 压力）
- **偏移量随机化**: 输入数据可以从页内的任何偏移量开始，有助于避免系统性缓存行对齐效应
- **缓存预热**: 缓冲区在构造时被访问，确保数据在基准测试迭代开始前已在缓存中

### 内存布局

```
|<-- page_size -->|<-- len -->|
+------------------+-----------+
|   offset space   |   data    |
+------------------+-----------+
^                  ^
buf start          actual data (offset varies)
```

## 预热迭代

预热迭代有助于确保：
- CPU 缓存填充了相关数据
- 分支预测器已训练
- 内存页已加载
